const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunk-v4-1760899745229-iU7ReY_7.js","assets/chunk-v4-1760899745229-Cp1U2DWw.js","assets/chunk-v4-1760899745229-DBZTXvvv.js","assets/chunk-v4-1760899745229-C91sa_mq.js"])))=>i.map(i=>d[i]);
import{r as u}from"./chunk-v4-1760899745229-Cp1U2DWw.js";import{c as m,_ as S}from"./chunk-v4-1760899745229-DBZTXvvv.js";const w={};var y={};async function g(r){const{data:e,error:t}=await i.from("holidays").select("*").eq("deleted",0).gte("date",`${r}-01-01`).lte("date",`${r}-12-31`);if(t)throw t;return e||[]}let d="",f="";typeof window<"u"&&typeof import.meta<"u"&&w?(d="https://dsltpiupbfopyvuiqffg.supabase.co",f="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzbHRwaXVwYmZvcHl2dWlxZmZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5Mjc3MzcsImV4cCI6MjA2NTUwMzczN30.suu_OSbTBSEkM3YMiPDFIAgDnX3bDavcD8BX4ZfYZxw"):typeof process<"u"&&y&&(d=y.SUPABASE_URL,f=y.SUPABASE_ANON_KEY||y.SUPABASE_KEY);const i=m(d,f);async function _(r,e){let t=i.from("deliveries").select("*").eq("deleted",0);r&&e!==void 0&&(t=t.gte("date",`${r}-${String(e+1).padStart(2,"0")}-01`).lt("date",`${r}-${String(e+2).padStart(2,"0")}-01`));const{data:s,error:n}=await t;if(n)throw n;return s||[]}async function v(){try{const{data:r,error:e}=await i.from("deliveries").select("zustellung_paketi").eq("deleted",0);if(e)throw e;return(r||[]).reduce((s,n)=>s+(parseInt(n.zustellung_paketi)||0),0)}catch{return 0}}async function I(){const{data:r,error:e}=await i.from("drivers").select("*").eq("deleted",0).eq("aktivan",!0).order("tura");if(e)throw e;return r||[]}const b=Object.freeze(Object.defineProperty({__proto__:null,getAllDeliveriesCloud:_,getAllDriversCloud:I,getAllHolidaysCloud:g,getTotalDeliveryCountCloud:v,supabase:i},Symbol.toStringTag,{value:"Module"}));async function R(){const{data:r,error:e}=await i.from("deliveries").select("*");if(e)throw e;return r}async function P(){const{data:r,error:e}=await i.from("drivers").select("*");if(e)throw e;return r}class C{constructor(){this.syncInterval=null,this.isRunning=!1,this.lastSyncTime=null,this.syncInProgress=!1,this.listeners=new Set,this.SYNC_INTERVAL=5*60*1e3,this.MIN_SYNC_DELAY=30*1e3,this.retryDelay=5e3,this.errorCount=0,this.maxErrors=10,this.isOnline=navigator.onLine,window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),this.loadPersistedState()}handleOnline(){this.isOnline=!0,this.errorCount=0,this.notifyListeners({type:"network",status:"online"}),this.isRunning&&setTimeout(()=>this.syncNow(),1e3)}handleOffline(){this.isOnline=!1,this.notifyListeners({type:"network",status:"offline"})}isNetworkAvailable(){return this.isOnline&&navigator.onLine}loadPersistedState(){try{const e=localStorage.getItem("autoSyncState");if(e){const t=JSON.parse(e);this.lastSyncTime=t.lastSyncTime,this.errorCount=t.errorCount||0}}catch{}}saveState(){try{const e={lastSyncTime:this.lastSyncTime,errorCount:this.errorCount,isRunning:this.isRunning};localStorage.setItem("autoSyncState",JSON.stringify(e))}catch{}}getSmartSyncInterval(){const e=new Date,t=e.getHours(),s=e.getDay();return s>=1&&s<=5&&t>=2&&t<=9?5*60*1e3:s>=1&&s<=5&&t>=9&&t<=18?15*60*1e3:60*60*1e3}start(e=null){this.isRunning||(this.SYNC_INTERVAL=e?e*60*1e3:this.getSmartSyncInterval(),this.isRunning=!0,this.syncNow(),this.syncInterval=setInterval(()=>{e||(clearInterval(this.syncInterval),this.SYNC_INTERVAL=this.getSmartSyncInterval(),this.syncInterval=setInterval(()=>this.syncNow(),this.SYNC_INTERVAL)),this.syncNow()},this.SYNC_INTERVAL),this.notifyListeners({type:"started"}))}stop(){this.isRunning&&(this.isRunning=!1,this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.notifyListeners({type:"stopped"}))}async syncNow(e=!1){if(this.syncInProgress&&!e)return{success:!1,reason:"already_in_progress"};if(!e&&this.lastSyncTime&&Date.now()-this.lastSyncTime<this.MIN_SYNC_DELAY)return{success:!1,reason:"min_delay"};if(!this.isNetworkAvailable())return this.notifyListeners({type:"error",error:"No network connection",code:"NETWORK_ERROR"}),{success:!1,reason:"no_network"};if(this.errorCount>=this.maxErrors)return this.notifyListeners({type:"error",error:`Too many sync errors (${this.errorCount}). Auto-sync paused.`,code:"MAX_ERRORS_REACHED"}),this.stop(),{success:!1,reason:"max_errors_reached"};this.syncInProgress=!0,this.notifyListeners({type:"sync_started"});try{let t=0;const s=3;for(;t<s;)try{return await R(),await P(),this.lastSyncTime=Date.now(),this.errorCount=0,this.saveState(),this.notifyListeners({type:"sync_success",timestamp:this.lastSyncTime,attempt:t+1}),{success:!0,timestamp:this.lastSyncTime}}catch(n){if(t++,this.errorCount++,t<s){const o=this.retryDelay*t;this.notifyListeners({type:"sync_retry",attempt:t,maxRetries:s,delay:o,error:n.message}),await new Promise(a=>setTimeout(a,o))}else return this.notifyListeners({type:"sync_failed",error:n.message,errorCount:this.errorCount,maxRetries:s}),this.saveState(),{success:!1,error:n,attempts:t}}}finally{this.syncInProgress=!1}}notifyListeners(e){this.listeners.forEach(t=>t(e))}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}}const l=new C;function O(){const[r,e]=u.useState(l.isRunning),[t,s]=u.useState(l.syncInProgress),[n,o]=u.useState(l.lastSyncTime);return u.useEffect(()=>{const a=c=>{c.type==="started"&&e(!0),c.type==="stopped"&&e(!1),c.type==="synced"&&o(l.lastSyncTime),s(l.syncInProgress)};return l.addListener(a),()=>l.removeListener(a)},[]),{isRunning:r,syncInProgress:t,lastSyncTime:n,start:a=>l.start(a),stop:()=>l.stop(),syncNow:a=>l.syncNow(a)}}async function N(r){const{data:e,error:t}=await i.storage.from("payrolls").list(r,{limit:100,offset:0});return t?[]:(e||[]).filter(s=>s.name&&s.name.endsWith(".pdf"))}async function L(r,e){const{data:t,error:s}=await i.storage.from("payrolls").download(`${r}/${e}`);if(s)return null;const n=window.URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(n)}async function E(r,e){const{error:t}=await i.storage.from("payrolls").upload(`${r}/${e.name}`,e,{cacheControl:"3600",upsert:!0,contentType:"application/pdf"});if(t)throw t;try{const{data:s,error:n}=await i.storage.from("payrolls").download(`${r}/${e.name}`);if(n||!s)return!0;const o=await s.arrayBuffer(),{extractNetoBrutoFromPDF:a}=await S(async()=>{const{extractNetoBrutoFromPDF:p}=await import("./chunk-v4-1760899745229-iU7ReY_7.js");return{extractNetoBrutoFromPDF:p}},__vite__mapDeps([0,1,2,3])),{neto:c,bruto:h}=await a(o);if(c>0||h>0){const p=await i.from("payroll_amounts").upsert({driver_name:r,file_name:e.name,neto:c,bruto:h},{onConflict:["driver_name","file_name"]})}}catch{}return!0}const k=Object.freeze(Object.defineProperty({__proto__:null,downloadPayrollFile:L,getPayrollFiles:N,uploadPayrollFile:E},Symbol.toStringTag,{value:"Module"}));export{k as S,g as a,N as b,I as c,L as d,v as e,b as f,_ as g,i as s,O as u};

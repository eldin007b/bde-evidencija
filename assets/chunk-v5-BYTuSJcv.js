const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunk-v5-BrZCLO-R.js","assets/chunk-v5-BnSIf2SQ.js","assets/chunk-v5-DgaHRPzO.js","assets/chunk-v5-gv7r2pb9.js"])))=>i.map(i=>d[i]);
import{a as u}from"./chunk-v5-BnSIf2SQ.js";import{c as m,_ as S}from"./chunk-v5-DgaHRPzO.js";const w={};var d={};async function g(r){const{data:e,error:t}=await i.from("holidays").select("*").eq("deleted",0).gte("date",`${r}-01-01`).lte("date",`${r}-12-31`);if(t)throw t;return e||[]}let f="",h="";typeof window<"u"&&typeof import.meta<"u"&&w?(console.log("VITE_SUPABASE_URL:","https://dsltpiupbfopyvuiqffg.supabase.co"),console.log("VITE_SUPABASE_ANON_KEY:","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzbHRwaXVwYmZvcHl2dWlxZmZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5Mjc3MzcsImV4cCI6MjA2NTUwMzczN30.suu_OSbTBSEkM3YMiPDFIAgDnX3bDavcD8BX4ZfYZxw"),f="https://dsltpiupbfopyvuiqffg.supabase.co",h="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzbHRwaXVwYmZvcHl2dWlxZmZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5Mjc3MzcsImV4cCI6MjA2NTUwMzczN30.suu_OSbTBSEkM3YMiPDFIAgDnX3bDavcD8BX4ZfYZxw"):typeof process<"u"&&d&&(f=d.SUPABASE_URL,h=d.SUPABASE_ANON_KEY||d.SUPABASE_KEY);const i=m(f,h);async function _(r,e){let t=i.from("deliveries").select("*").eq("deleted",0);if(r&&e!==void 0){const o=e+2,n=o>12?r+1:r,c=o>12?1:o;t=t.gte("date",`${r}-${String(e+1).padStart(2,"0")}-01`).lt("date",`${n}-${String(c).padStart(2,"0")}-01`)}const{data:s,error:a}=await t;if(a)throw a;return s||[]}async function I(){try{const{data:r,error:e}=await i.from("deliveries").select("zustellung_paketi").eq("deleted",0);if(e)throw e;return(r||[]).reduce((s,a)=>s+(parseInt(a.zustellung_paketi)||0),0)}catch(r){return console.error("Gre≈°ka pri dohvatanju ukupnog broja dostava:",r),0}}async function v(){const{data:r,error:e}=await i.from("drivers").select("*").eq("deleted",0).eq("aktivan",!0).order("tura");if(e)throw e;return r||[]}async function N(r,e,t){let s=i.from("deliveries").select("*").eq("deleted",0).eq("driver",r);if(e&&(s=s.gte("date",`${e}-01-01`).lte("date",`${e}-12-31`)),t!==void 0){const n=String(t+1).padStart(2,"0");s=s.gte("date",`${e}-${n}-01`).lte("date",`${e}-${n}-31`)}const{data:a,error:o}=await s.order("date",{ascending:!0});if(o)throw o;return(a||[]).map(n=>({date:n.date,stopovi:n.produktivitaet_stops||0,paketi:n.zustellung_paketi||0,pickup:n.pickup_paketi||0,reklamacije:n.probleme_prva?1:0,efikasnost:n.zustellung_proc?parseInt(n.zustellung_proc):0,stopH:n.produktivitaet_stops_pro_std||0}))}const T=Object.freeze(Object.defineProperty({__proto__:null,getAllDeliveriesCloud:_,getAllDriversCloud:v,getAllHolidaysCloud:g,getDeliveriesByDriverCloud:N,getTotalDeliveryCountCloud:I,supabase:i},Symbol.toStringTag,{value:"Module"}));async function R(){const{data:r,error:e}=await i.from("deliveries").select("*");if(e)throw e;return r}async function P(){const{data:r,error:e}=await i.from("drivers").select("*");if(e)throw e;return r}class C{constructor(){this.syncInterval=null,this.isRunning=!1,this.lastSyncTime=null,this.syncInProgress=!1,this.listeners=new Set,this.SYNC_INTERVAL=300*1e3,this.MIN_SYNC_DELAY=30*1e3,this.retryDelay=5e3,this.errorCount=0,this.maxErrors=10,this.isOnline=navigator.onLine,window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),this.loadPersistedState()}handleOnline(){console.log("üåê Network connection restored"),this.isOnline=!0,this.errorCount=0,this.notifyListeners({type:"network",status:"online"}),this.isRunning&&setTimeout(()=>this.syncNow(),1e3)}handleOffline(){console.log("üåê Network connection lost"),this.isOnline=!1,this.notifyListeners({type:"network",status:"offline"})}isNetworkAvailable(){return this.isOnline&&navigator.onLine}loadPersistedState(){try{const e=localStorage.getItem("autoSyncState");if(e){const t=JSON.parse(e);this.lastSyncTime=t.lastSyncTime,this.errorCount=t.errorCount||0}}catch(e){console.warn("Failed to load persisted sync state:",e)}}saveState(){try{const e={lastSyncTime:this.lastSyncTime,errorCount:this.errorCount,isRunning:this.isRunning};localStorage.setItem("autoSyncState",JSON.stringify(e))}catch(e){console.warn("Failed to save sync state:",e)}}getSmartSyncInterval(){const e=new Date,t=e.getHours(),s=e.getDay();return s>=1&&s<=5&&t>=2&&t<=9?300*1e3:s>=1&&s<=5&&t>=9&&t<=18?900*1e3:3600*1e3}start(e=null){this.isRunning||(this.SYNC_INTERVAL=e?e*60*1e3:this.getSmartSyncInterval(),this.isRunning=!0,this.syncNow(),this.syncInterval=setInterval(()=>{e||(clearInterval(this.syncInterval),this.SYNC_INTERVAL=this.getSmartSyncInterval(),this.syncInterval=setInterval(()=>this.syncNow(),this.SYNC_INTERVAL)),this.syncNow()},this.SYNC_INTERVAL),console.log(`üîÑ AutoSync started with ${this.SYNC_INTERVAL/6e4} min interval`),this.notifyListeners({type:"started"}))}stop(){this.isRunning&&(this.isRunning=!1,this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.notifyListeners({type:"stopped"}))}async syncNow(e=!1){if(this.syncInProgress&&!e)return{success:!1,reason:"already_in_progress"};if(!e&&this.lastSyncTime&&Date.now()-this.lastSyncTime<this.MIN_SYNC_DELAY)return{success:!1,reason:"min_delay"};if(!this.isNetworkAvailable())return this.notifyListeners({type:"error",error:"No network connection",code:"NETWORK_ERROR"}),{success:!1,reason:"no_network"};if(this.errorCount>=this.maxErrors)return this.notifyListeners({type:"error",error:`Too many sync errors (${this.errorCount}). Auto-sync paused.`,code:"MAX_ERRORS_REACHED"}),this.stop(),{success:!1,reason:"max_errors_reached"};this.syncInProgress=!0,this.notifyListeners({type:"sync_started"});try{let t=0;const s=3;for(;t<s;)try{return console.log(`üîÑ Starting sync attempt ${t+1}/${s}`),await R(),await P(),this.lastSyncTime=Date.now(),this.errorCount=0,this.saveState(),this.notifyListeners({type:"sync_success",timestamp:this.lastSyncTime,attempt:t+1}),console.log("‚úÖ Sync completed successfully"),{success:!0,timestamp:this.lastSyncTime}}catch(a){if(t++,this.errorCount++,console.error(`‚ùå Sync attempt ${t} failed:`,a),t<s){const o=this.retryDelay*t;console.log(`‚è≥ Retrying in ${o/1e3} seconds...`),this.notifyListeners({type:"sync_retry",attempt:t,maxRetries:s,delay:o,error:a.message}),await new Promise(n=>setTimeout(n,o))}else return this.notifyListeners({type:"sync_failed",error:a.message,errorCount:this.errorCount,maxRetries:s}),this.saveState(),{success:!1,error:a,attempts:t}}}finally{this.syncInProgress=!1}}notifyListeners(e){this.listeners.forEach(t=>t(e))}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}}const l=new C;function D(){const[r,e]=u.useState(l.isRunning),[t,s]=u.useState(l.syncInProgress),[a,o]=u.useState(l.lastSyncTime);return u.useEffect(()=>{const n=c=>{c.type==="started"&&e(!0),c.type==="stopped"&&e(!1),c.type==="synced"&&o(l.lastSyncTime),s(l.syncInProgress)};return l.addListener(n),()=>l.removeListener(n)},[]),{isRunning:r,syncInProgress:t,lastSyncTime:a,start:n=>l.start(n),stop:()=>l.stop(),syncNow:n=>l.syncNow(n)}}async function E(r){const{data:e,error:t}=await i.storage.from("payrolls").list(r,{limit:100,offset:0});return t?(console.error("Gre≈°ka pri listanju fajlova:",t),[]):(e||[]).filter(s=>s&&s.name&&typeof s.name=="string"&&s.name.endsWith(".pdf"))}async function A(r,e){const{data:t,error:s}=await i.storage.from("payrolls").download(`${r}/${e}`);if(s)return console.error("Gre≈°ka pri downloadu fajla:",s),null;const a=window.URL.createObjectURL(t),o=document.createElement("a");o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(a)}async function k(r,e){console.log("[uploadPayrollFile] Poƒçetak upload:",r,e.name);const{error:t}=await i.storage.from("payrolls").upload(`${r}/${e.name}`,e,{cacheControl:"3600",upsert:!0,contentType:"application/pdf"});if(t)throw console.error("[uploadPayrollFile] Gre≈°ka pri uploadu:",t),t;console.log("[uploadPayrollFile] Upload OK:",r,e.name);try{const{data:s,error:a}=await i.storage.from("payrolls").download(`${r}/${e.name}`);if(a||!s)return console.error("[uploadPayrollFile] Gre≈°ka pri downloadu PDF-a:",a),!0;console.log("[uploadPayrollFile] Download OK:",r,e.name);const o=await s.arrayBuffer(),{extractNetoBrutoFromPDF:n}=await S(async()=>{const{extractNetoBrutoFromPDF:p}=await import("./chunk-v5-BrZCLO-R.js");return{extractNetoBrutoFromPDF:p}},__vite__mapDeps([0,1,2,3])),{neto:c,bruto:y}=await n(o);if(console.log("[uploadPayrollFile] Parsed PDF:",e.name,"neto:",c,"bruto:",y),c>0||y>0){const p=await i.from("payroll_amounts").upsert({driver_name:r,file_name:e.name,neto:c,bruto:y},{onConflict:["driver_name","file_name"]});console.log("[uploadPayrollFile] Upsert payroll_amounts:",p)}else console.warn("[uploadPayrollFile] Neto/bruto nisu > 0, preskaƒçem upsert.")}catch(s){console.error("[uploadPayrollFile] Gre≈°ka u parsiranju/upsertu:",s)}return!0}const O=Object.freeze(Object.defineProperty({__proto__:null,downloadPayrollFile:A,getPayrollFiles:E,uploadPayrollFile:k},Symbol.toStringTag,{value:"Module"}));export{O as S,g as a,v as b,N as c,E as d,A as e,I as f,_ as g,T as h,i as s,D as u};

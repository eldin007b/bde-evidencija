const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunk-v5-O07xQYXy.js","assets/chunk-v5-BnSIf2SQ.js","assets/chunk-v5-DgaHRPzO.js","assets/chunk-v5-gv7r2pb9.js"])))=>i.map(i=>d[i]);
import{a as u}from"./chunk-v5-BnSIf2SQ.js";import{c as m,_ as S}from"./chunk-v5-DgaHRPzO.js";const g={};var y={};async function w(s){const{data:e,error:t}=await a.from("holidays").select("*").eq("deleted",0).gte("date",`${s}-01-01`).lte("date",`${s}-12-31`);if(t)throw t;return e||[]}let h="",p="";typeof window<"u"&&typeof import.meta<"u"&&g?(console.log("VITE_SUPABASE_URL:","https://dsltpiupbfopyvuiqffg.supabase.co"),console.log("VITE_SUPABASE_ANON_KEY:","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzbHRwaXVwYmZvcHl2dWlxZmZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5Mjc3MzcsImV4cCI6MjA2NTUwMzczN30.suu_OSbTBSEkM3YMiPDFIAgDnX3bDavcD8BX4ZfYZxw"),h="https://dsltpiupbfopyvuiqffg.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzbHRwaXVwYmZvcHl2dWlxZmZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5Mjc3MzcsImV4cCI6MjA2NTUwMzczN30.suu_OSbTBSEkM3YMiPDFIAgDnX3bDavcD8BX4ZfYZxw"):typeof process<"u"&&y&&(h=y.SUPABASE_URL,p=y.SUPABASE_ANON_KEY||y.SUPABASE_KEY);const a=m(h,p);async function _(s,e){let t=a.from("deliveries").select("*").eq("deleted",0);if(s&&e!==void 0){const i=e+2,o=i>12?s+1:s,c=i>12?1:i;t=t.gte("date",`${s}-${String(e+1).padStart(2,"0")}-01`).lt("date",`${o}-${String(c).padStart(2,"0")}-01`)}const{data:r,error:n}=await t;if(n)throw n;return r||[]}async function I(){try{const{data:s,error:e}=await a.from("deliveries").select("zustellung_paketi").eq("deleted",0);if(e)throw e;return(s||[]).reduce((r,n)=>r+(parseInt(n.zustellung_paketi)||0),0)}catch(s){return console.error("Gre≈°ka pri dohvatanju ukupnog broja dostava:",s),0}}async function v(){const{data:s,error:e}=await a.from("drivers").select("*").eq("deleted",0).eq("aktivan",!0).order("tura");if(e)throw e;return s||[]}const L=Object.freeze(Object.defineProperty({__proto__:null,getAllDeliveriesCloud:_,getAllDriversCloud:v,getAllHolidaysCloud:w,getTotalDeliveryCountCloud:I,supabase:a},Symbol.toStringTag,{value:"Module"}));async function N(){const{data:s,error:e}=await a.from("deliveries").select("*");if(e)throw e;return s}async function P(){const{data:s,error:e}=await a.from("drivers").select("*");if(e)throw e;return s}class R{constructor(){this.syncInterval=null,this.isRunning=!1,this.lastSyncTime=null,this.syncInProgress=!1,this.listeners=new Set,this.SYNC_INTERVAL=300*1e3,this.MIN_SYNC_DELAY=30*1e3,this.retryDelay=5e3,this.errorCount=0,this.maxErrors=10,this.isOnline=navigator.onLine,window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),this.loadPersistedState()}handleOnline(){console.log("üåê Network connection restored"),this.isOnline=!0,this.errorCount=0,this.notifyListeners({type:"network",status:"online"}),this.isRunning&&setTimeout(()=>this.syncNow(),1e3)}handleOffline(){console.log("üåê Network connection lost"),this.isOnline=!1,this.notifyListeners({type:"network",status:"offline"})}isNetworkAvailable(){return this.isOnline&&navigator.onLine}loadPersistedState(){try{const e=localStorage.getItem("autoSyncState");if(e){const t=JSON.parse(e);this.lastSyncTime=t.lastSyncTime,this.errorCount=t.errorCount||0}}catch(e){console.warn("Failed to load persisted sync state:",e)}}saveState(){try{const e={lastSyncTime:this.lastSyncTime,errorCount:this.errorCount,isRunning:this.isRunning};localStorage.setItem("autoSyncState",JSON.stringify(e))}catch(e){console.warn("Failed to save sync state:",e)}}getSmartSyncInterval(){const e=new Date,t=e.getHours(),r=e.getDay();return r>=1&&r<=5&&t>=2&&t<=9?300*1e3:r>=1&&r<=5&&t>=9&&t<=18?900*1e3:3600*1e3}start(e=null){this.isRunning||(this.SYNC_INTERVAL=e?e*60*1e3:this.getSmartSyncInterval(),this.isRunning=!0,this.syncNow(),this.syncInterval=setInterval(()=>{e||(clearInterval(this.syncInterval),this.SYNC_INTERVAL=this.getSmartSyncInterval(),this.syncInterval=setInterval(()=>this.syncNow(),this.SYNC_INTERVAL)),this.syncNow()},this.SYNC_INTERVAL),console.log(`üîÑ AutoSync started with ${this.SYNC_INTERVAL/6e4} min interval`),this.notifyListeners({type:"started"}))}stop(){this.isRunning&&(this.isRunning=!1,this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.notifyListeners({type:"stopped"}))}async syncNow(e=!1){if(this.syncInProgress&&!e)return{success:!1,reason:"already_in_progress"};if(!e&&this.lastSyncTime&&Date.now()-this.lastSyncTime<this.MIN_SYNC_DELAY)return{success:!1,reason:"min_delay"};if(!this.isNetworkAvailable())return this.notifyListeners({type:"error",error:"No network connection",code:"NETWORK_ERROR"}),{success:!1,reason:"no_network"};if(this.errorCount>=this.maxErrors)return this.notifyListeners({type:"error",error:`Too many sync errors (${this.errorCount}). Auto-sync paused.`,code:"MAX_ERRORS_REACHED"}),this.stop(),{success:!1,reason:"max_errors_reached"};this.syncInProgress=!0,this.notifyListeners({type:"sync_started"});try{let t=0;const r=3;for(;t<r;)try{return console.log(`üîÑ Starting sync attempt ${t+1}/${r}`),await N(),await P(),this.lastSyncTime=Date.now(),this.errorCount=0,this.saveState(),this.notifyListeners({type:"sync_success",timestamp:this.lastSyncTime,attempt:t+1}),console.log("‚úÖ Sync completed successfully"),{success:!0,timestamp:this.lastSyncTime}}catch(n){if(t++,this.errorCount++,console.error(`‚ùå Sync attempt ${t} failed:`,n),t<r){const i=this.retryDelay*t;console.log(`‚è≥ Retrying in ${i/1e3} seconds...`),this.notifyListeners({type:"sync_retry",attempt:t,maxRetries:r,delay:i,error:n.message}),await new Promise(o=>setTimeout(o,i))}else return this.notifyListeners({type:"sync_failed",error:n.message,errorCount:this.errorCount,maxRetries:r}),this.saveState(),{success:!1,error:n,attempts:t}}}finally{this.syncInProgress=!1}}notifyListeners(e){this.listeners.forEach(t=>t(e))}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}}const l=new R;function b(){const[s,e]=u.useState(l.isRunning),[t,r]=u.useState(l.syncInProgress),[n,i]=u.useState(l.lastSyncTime);return u.useEffect(()=>{const o=c=>{c.type==="started"&&e(!0),c.type==="stopped"&&e(!1),c.type==="synced"&&i(l.lastSyncTime),r(l.syncInProgress)};return l.addListener(o),()=>l.removeListener(o)},[]),{isRunning:s,syncInProgress:t,lastSyncTime:n,start:o=>l.start(o),stop:()=>l.stop(),syncNow:o=>l.syncNow(o)}}async function A(s){const{data:e,error:t}=await a.storage.from("payrolls").list(s,{limit:100,offset:0});return t?(console.error("Gre≈°ka pri listanju fajlova:",t),[]):(e||[]).filter(r=>r&&r.name&&typeof r.name=="string"&&r.name.endsWith(".pdf"))}async function E(s,e){console.log("[uploadPayrollFile] Poƒçetak upload:",s,e.name);const{error:t}=await a.storage.from("payrolls").upload(`${s}/${e.name}`,e,{cacheControl:"3600",upsert:!0,contentType:"application/pdf"});if(t)throw console.error("[uploadPayrollFile] Gre≈°ka pri uploadu:",t),t;console.log("[uploadPayrollFile] Upload OK:",s,e.name);try{const{data:r,error:n}=await a.storage.from("payrolls").download(`${s}/${e.name}`);if(n||!r)return console.error("[uploadPayrollFile] Gre≈°ka pri downloadu PDF-a:",n),!0;console.log("[uploadPayrollFile] Download OK:",s,e.name);const i=await r.arrayBuffer(),{extractNetoBrutoFromPDF:o}=await S(async()=>{const{extractNetoBrutoFromPDF:f}=await import("./chunk-v5-O07xQYXy.js");return{extractNetoBrutoFromPDF:f}},__vite__mapDeps([0,1,2,3])),{neto:c,bruto:d}=await o(i);if(console.log("[uploadPayrollFile] Parsed PDF:",e.name,"neto:",c,"bruto:",d),c>0||d>0){const f=await a.from("payroll_amounts").upsert({driver_name:s,file_name:e.name,neto:c,bruto:d},{onConflict:["driver_name","file_name"]});console.log("[uploadPayrollFile] Upsert payroll_amounts:",f)}else console.warn("[uploadPayrollFile] Neto/bruto nisu > 0, preskaƒçem upsert.")}catch(r){console.error("[uploadPayrollFile] Gre≈°ka u parsiranju/upsertu:",r)}return!0}const D=Object.freeze(Object.defineProperty({__proto__:null,getPayrollFiles:A,uploadPayrollFile:E},Symbol.toStringTag,{value:"Module"}));export{D as S,w as a,v as b,I as c,A as d,L as e,_ as g,a as s,b as u};
